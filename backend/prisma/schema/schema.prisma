datasource db {
    provider = "postgresql"
    schemas  = ["app"]
}

generator client {
    provider = "prisma-client-js"
    output   = "../generated/prisma"
}

enum FileType {
    IMAGE
    TEXT
    AUDIO

    @@schema("app")
}

enum AnalysisStatus {
    PENDING // Image uploaded, not yet analyzed
    ANALYZING // LLM processing in progress
    COMPLETED // Analysis done, awaiting user validation
    COMMITTED // User accepted, saved to DB
    DECLINED // User rejected
    ERROR // Analysis failed

    @@schema("app")
}

model ImageUpload {
    id                String             @id @default(uuid())
    userId            String             @map("user_id")
    analysisId        String             @map("analysis_id")
    type              FileType
    fileKey           String             @map("file_key")
    compressedFileKey String?            @map("compressed_file_key")
    createdAt         DateTime           @default(now()) @map("created_at")
    user              User               @relation(fields: [userId], references: [id])
    analysis          IngredientAnalysis @relation(fields: [analysisId], references: [id])

    @@index([analysisId])
    @@map("image_uploads")
    @@schema("app")
}

model IngredientAnalysis {
    id     String         @id @default(uuid())
    userId String         @map("user_id")
    status AnalysisStatus @default(PENDING)

    // Full LLM response as JSON - source of truth for LLM queries
    // Contains: mealTitle, mealDescription, ingredients[], nutritionFacts{}, allergens[], healthFlags[]
    analysisData Json? @map("analysis_data")

    // Extracted searchable fields (for pre-filtering before sending to LLM)
    mealTitle       String?  @map("meal_title")
    mealDescription String?  @map("meal_description")
    totalCalories   Decimal? @map("total_calories") @db.Decimal(10, 2)
    totalSugar      Decimal? @map("total_sugar") @db.Decimal(10, 2)
    totalCarbs      Decimal? @map("total_carbs") @db.Decimal(10, 2)
    totalProtein    Decimal? @map("total_protein") @db.Decimal(10, 2)

    createdAt   DateTime  @default(now()) @map("created_at")
    analyzedAt  DateTime? @map("analyzed_at")
    committedAt DateTime? @map("committed_at")

    user   User          @relation(fields: [userId], references: [id])
    images ImageUpload[]

    @@index([userId, analyzedAt])
    @@index([userId, status])
    @@map("ingredient_analyses")
    @@schema("app")
}

model User {
    id                 String               @id @default(uuid())
    email              String               @unique
    password           String
    analysisImages     ImageUpload[]
    ingredientAnalyses IngredientAnalysis[]

    @@map("users")
    @@schema("app")
}
